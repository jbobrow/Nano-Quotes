<html>
    <head>
        <title>Welcome to Nanotronics</title>
        <link href="css/flapper.css" type="text/css" rel="stylesheet" />
        <script src="libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="transform/dist/jquery.transform-0.9.3.min.js"></script>
        <script src="src/jquery.flapper.js"></script>
        <script src="src/flapdemo.js"></script>
        <style type="text/css">
            body {
                font-family: "Helvetica Neue", Arial, sans-serif;
                color: #333;
                background-color: #fff;
            }

            .page {
                width: 1200px;
                margin: 100px auto 0;
            }

            h1 {
                text-align: center;
                font-size: 24px;
            }

            .displays {
                padding: 80px;
                background-color: #000;
                border-radius: 0px;
                box-shadow: 0 0 12px 4px #000 inset;
            }

            .flapper {
                margin-bottom: 2px;
                text-align: center;
            }

            .inputarea {
                display: none; /* Hide input area */
            }

            #quote {
                font-family: sans-serif;
                font-size: 1.2em;
                text-align: center;
                margin-bottom: 10px;
                color: #000;
            }

            #author {
                font-family: sans-serif;
                font-size: 1.2em;
                color: #000;
                text-align: center;
            }
            #thanks {
                display: none;
                font-family: Courier;
                font-weight: lighter;
                font-size: 1.4em;
                color: #ffffff;
                text-shadow: 2px 2px 2px rgba(0,0,0,0.1);
                text-align: center;                
            }

            div.inline {
                display: inline-block;
                vertical-align: bottom;
            }

            div.activity {
                width: 12px;
                height: 12px;
                border-radius: 6px;
                background-color: #250000;
                position: relative;
                top: 33px;
                left: -15px;
            }

            div.activity.active {
                background-color: #f00;
            }
        </style>
    </head>
    <body>
        <div class="page">
            <!-- <h1>FLAPPER DEMO</h1> -->
            <div class="displays">
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
            </div>
            <div id="thanks">
                <p>Thanks to Paul Henrique for providing these quotes day in, day out.<br>Now we share them with you.</p>
            </div>
<!--             <div class="inputarea">
                <div class="inline"><textarea id="typesomething" placeholder="Type Something Here..." rows="6" cols="20"></textarea></div>
                <div class="inline"><button id="showme">And Click Here</button></div>
            </div> -->
        </div>
        <script>
            let flapDemo;

            async function fetchQuotes() {
                try {
                    const response = await fetch('quotes.csv');
                    const csvText = await response.text();
                    return parseCSV(csvText);
                } catch (error) {
                    console.error('Failed to fetch quotes:', error);
                    return [];
                }
            }

            function parseCSV(csvText) {
                const rows = csvText.split('\n').slice(1); // Skip header row
                return rows
                    .map(row => {
                        const columns = row.split(',');
                        if (columns.length < 3) return null; // Ensure there are at least 3 columns
                        const [date, quote, author] = columns;
                        return {
                            date: date?.trim(),
                            quote: quote?.trim(),
                            author: author?.trim(),
                        };
                    })
                    .filter(row => row && row.quote && row.author); // Remove empty or invalid rows
            }

            function formatQuoteForDisplay(quote, author, wrap, numLines) {
                const fullText = `${quote}                   -${author}`;
                const buffer = new FlapBuffer(wrap, numLines);
                const words = fullText.split(/\s+/);

                words.forEach(word => buffer.pushWord(word));
                buffer.flush();

                // console.log('Formatted buffers:', buffer.buffers);

                return buffer.buffers;
            }

            function displayQuote(quotes) {
                if (quotes.length === 0) {
                    flapDemo.updateDisplay([['No quotes available.']]);
                    return;
                }

                const randomIndex = Math.floor(Math.random() * quotes.length);
                const { quote, author } = quotes[randomIndex];

                const formattedBuffers = formatQuoteForDisplay(quote, author, 22, 6); // Adjust width and line count
                flapDemo.updateDisplay(formattedBuffers);
            }

            async function init() {
                flapDemo = new FlapDemo('input.display', '#typesomething', '#showme');
                const quotes = await fetchQuotes();
                if (quotes.length > 0) {
                    displayQuote(quotes);
                    setInterval(() => displayQuote(quotes), 30000); // Update every 30 seconds
                }
            }

            init();
        </script>
    </body>
</html>