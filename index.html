<html>
    <head>
        <title>Welcome to Nanotronics</title>
        <link href="css/flapper.css" type="text/css" rel="stylesheet" />
        <script src="libs/jquery/1.8.2/jquery.min.js"></script>
        <script src="transform/dist/jquery.transform-0.9.3.min.js"></script>
        <script src="src/jquery.flapper.js"></script>
        <script src="src/flapdemo.js"></script>
        <style type="text/css">
            body {
                font-family: "Helvetica Neue", Arial, sans-serif;
                color: #333;
                background-color: #fff;
            }

            .page {
                width: 1200px;
                margin: 50px auto 0;
            }

            h1 {
                text-align: center;
                font-size: 24px;
            }

            .displays {
                padding: 80px;
                background-color: #000;
                border-radius: 0px;
                box-shadow: 0 0 12px 4px #000 inset;
            }

            .flapper {
                margin-bottom: 2px;
                text-align: center;
            }

            .inputarea {
                display: none; /* Hide input area */
            }

            #quote {
                font-family: sans-serif;
                font-size: 1.2em;
                text-align: center;
                margin-bottom: 10px;
                color: #000;
            }

            #author {
                font-family: sans-serif;
                font-size: 1.2em;
                color: #000;
                text-align: center;
            }
            #thanks {
/*                display: none;*/
                max-width: 600px;
                height: 40%;
                margin: 0 auto;
                font-family: "Helvetica Neue", Arial, sans-serif;
                font-size: 1em;
                line-height: 1.5em;
                color: #444;
                text-align: justify;
                align-content: center;                
            }

            #thanks a {
                color: #888;
                text-decoration: none;
            }

            #thanks a:hover {
                color: #444;
                text-decoration: underline;
            }

            div.inline {
                display: inline-block;
                vertical-align: bottom;
            }

            div.activity {
                width: 12px;
                height: 12px;
                border-radius: 6px;
                background-color: #250000;
                position: relative;
                top: 33px;
                left: -15px;
            }

            div.activity.active {
                background-color: #f00;
            }
        </style>
    </head>
    <body>
        <div class="page">
            <!-- <h1>FLAPPER DEMO</h1> -->
            <div class="displays">
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
                <div class="activity"></div><input class="display M" />
            </div>
            <div id="thanks">
                <p>At <a href="https://nanotronics.ai">Nanotronics</a>, many of us start each morning walking into Building 20, greeted by a mechanical display board, much like the one found in old train stations. This digital display board is populated with quotes that have been shared with the Nanotronics family over the years and will continue to update with quotes selected by Paul Henrique, Security Manager for Building 20 since 2019. We hope these quotes provide inspiration for you, just like they have for us&#8212;day in, day out.</p>
            </div>
<!--             <div class="inputarea">
                <div class="inline"><textarea id="typesomething" placeholder="Type Something Here..." rows="6" cols="20"></textarea></div>
                <div class="inline"><button id="showme">And Click Here</button></div>
            </div> -->
        </div>
        <script>
            let flapDemo;

            async function fetchQuotes() {
                try {
                    const response = await fetch('quotes.csv');
                    const csvText = await response.text();
                    return parseCSV(csvText);
                } catch (error) {
                    console.error('Failed to fetch quotes:', error);
                    return [];
                }
            }

            function parseCSV(csvText) {
                const rows = csvText.split('\n').slice(1); // Skip header row
                return rows
                    .map(row => {
                        // Match CSV fields, including those enclosed in double quotes
                        const columns = row.match(/(?:[^,""]+|"[^"]*")+/g);
                        if (!columns || columns.length < 3) return null; // Ensure there are at least 3 columns

                        // Remove surrounding quotes from fields and trim whitespace
                        const [date, quote, author] = columns.map(col =>
                            col.replace(/^"|"$/g, '').trim()
                        );

                        return {
                            date,
                            quote,
                            author,
                        };
                    })
                    .filter(row => 
                        row && 
                        row.quote && 
                        row.author && 
                        row.quote.length <= 100 // Filter out long quotes
                    ); // Remove empty, invalid, or overly long quotes
            }

            function formatQuoteForDisplay(quote, author, wrap, numLines) {
                const quoteText = `${quote}`;
                const buffer = new FlapBuffer(wrap, numLines);
                const words = quote.split(/\s+/);
                const authorName = `${author}`;
                const authorNameWords = authorName.split(/\s+/);

                // add quote
                words.forEach(word => buffer.pushWord(word));
                buffer.flush();

                // add author on the next line
                buffer.pushWord(`-`);
                authorNameWords.forEach(nameWord => buffer.pushWord(nameWord));
                buffer.flush();

                // console.log('Formatted buffers:', buffer.buffers);

                return buffer.buffers;
            }

            function displayQuote(quotes) {
                if (quotes.length === 0) {
                    flapDemo.updateDisplay([['No quotes available.']]);
                    return;
                }

                const randomIndex = Math.floor(Math.random() * quotes.length);
                const { quote, author } = quotes[randomIndex];

                const formattedBuffers = formatQuoteForDisplay(quote, author, 22, 6); // Adjust width and line count
                flapDemo.updateDisplay(formattedBuffers);
            }

            async function init() {
                flapDemo = new FlapDemo('input.display', '#typesomething', '#showme');
                const quotes = await fetchQuotes();
                if (quotes.length > 0) {
                    displayQuote(quotes);
                    setInterval(() => displayQuote(quotes), 30000); // Update every 30 seconds
                }
            }

            init();
        </script>
    </body>
</html>